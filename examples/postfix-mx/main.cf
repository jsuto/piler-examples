# Postfix MX relay for piler email archiving
# Hostname: ingest.example.com
# Purpose: Receive emails for archive.example.com and distribute
#          them across piler worker nodes via round-robin MX lookup.

# ---------------------------------------------------------------
# Identity
# ---------------------------------------------------------------
smtpd_banner        = $myhostname ESMTP
myhostname          = ingest.example.com
mydomain            = example.com
myorigin            = $mydomain

# This server does NOT do local delivery.
mydestination       =
local_transport     = error:5.1.1 Mailbox unavailable
mynetworks          = 127.0.0.0/8 [::1]/128

# ---------------------------------------------------------------
# Relay configuration
# ---------------------------------------------------------------
# Accept mail for archive.example.com and relay to worker pool.
relay_domains       = archive.example.com
transport_maps      = hash:/etc/postfix/transport

# ---------------------------------------------------------------
# TLS – inbound (opportunistic)
# ---------------------------------------------------------------
smtpd_tls_cert_file     = /etc/postfix/tls/ingest.example.com.crt
smtpd_tls_key_file      = /etc/postfix/tls/ingest.example.com.key
smtpd_tls_security_level = may
smtpd_tls_protocols     = >=TLSv1.2
smtpd_tls_ciphers       = high
smtpd_tls_session_cache_database = btree:${data_directory}/smtpd_scache

# ---------------------------------------------------------------
# TLS – outbound to workers (optional; skip if internal network)
# ---------------------------------------------------------------
smtp_tls_security_level  = none

# ---------------------------------------------------------------
# Recipient restrictions
# ---------------------------------------------------------------
smtpd_relay_restrictions =
    permit_mynetworks,
    reject_unauth_destination

smtpd_recipient_restrictions =
    permit_mynetworks,
    reject_non_fqdn_recipient,
    reject_unknown_recipient_domain,
    reject_unauth_destination

smtpd_helo_required = yes
smtpd_helo_restrictions =
    permit_mynetworks,
    reject_invalid_helo_hostname,
    reject_non_fqdn_helo_hostname

smtpd_sender_restrictions =
    reject_non_fqdn_sender,
    reject_unknown_sender_domain

# ---------------------------------------------------------------
# Connection / rate limits (tune to your traffic volume)
# ---------------------------------------------------------------
smtpd_client_connection_count_limit = 50
smtpd_client_message_rate_limit     = 200
smtpd_client_recipient_rate_limit   = 500

# ---------------------------------------------------------------
# Queue tuning
# ---------------------------------------------------------------
maximal_queue_lifetime = 3d
bounce_queue_lifetime  = 1d
queue_run_delay        = 60s
minimal_backoff_time   = 120s
maximal_backoff_time   = 1800s

# ---------------------------------------------------------------
# Message size limit (50 MB – match piler's limit)
# ---------------------------------------------------------------
message_size_limit = 52428800

# ---------------------------------------------------------------
# Relay transport tuning
# ---------------------------------------------------------------
# Keep persistent connections to workers; speeds up delivery.
relay_destination_concurrency_limit  = 20
relay_destination_recipient_limit    = 50

# ---------------------------------------------------------------
# Logging
# ---------------------------------------------------------------
smtpd_tls_loglevel = 1
